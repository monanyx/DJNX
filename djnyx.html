<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DJ Deck</title>
  <style>
    :root {
      --bg: #0a0a0c;
      --deck: #1a1a1f;
      --platter: #0f0f12;
      --accent: #c9a227;
      --led: #ff3333;
      --text: #e0e0e0;
      --muted: #666;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    
    .mixer-section {
      width: 100%;
      max-width: 1200px;
      background: linear-gradient(180deg, #222 0%, #111 100%);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #333;
      box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    }
    
    .decks-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      max-width: 1200px;
    }
    
    @media (max-width: 900px) {
      .decks-container { grid-template-columns: 1fr; }
    }
    
    .deck {
      background: linear-gradient(145deg, #2a2a30 0%, #1a1a1f 100%);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #333;
      box-shadow: 
        inset 0 1px 0 rgba(255,255,255,0.05),
        0 20px 60px rgba(0,0,0,0.6);
      position: relative;
    }
    
    .deck-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }
    
    .deck-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--accent);
      font-weight: 700;
    }
    
    .power-btn {
      width: 40px;
      height: 20px;
      background: #222;
      border: 1px solid #444;
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .power-btn.active {
      background: #1a3a1a;
      border-color: #2a5a2a;
    }
    
    .power-btn::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: #555;
      border-radius: 50%;
      top: 1px;
      left: 2px;
      transition: all 0.2s;
    }
    
    .power-btn.active::after {
      background: #4a4;
      left: 20px;
      box-shadow: 0 0 10px #4a4;
    }
    
    .platter-area {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      margin-bottom: 20px;
    }
    
    /* Realistic platter with strobe dots */
    .platter-base {
      position: absolute;
      inset: 0;
      background: 
        /* Strobe dots rings */
        repeating-conic-gradient(
          from 0deg,
          transparent 0deg 1deg,
          #333 1deg 2deg
        ),
        radial-gradient(circle at 50% 50%, #1a1a1f 0% 45%, #0f0f12 45% 100%);
      border-radius: 50%;
      border: 8px solid #151518;
      box-shadow: 
        inset 0 0 60px rgba(0,0,0,0.8),
        0 10px 40px rgba(0,0,0,0.5);
    }
    
    .strobe-ring {
      position: absolute;
      inset: 5%;
      border-radius: 50%;
      border: 1px solid #333;
    }
    
    .strobe-dots {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background-image: 
        /* 33⅓ RPM dots */
        radial-gradient(circle at 50% 15%, #666 0px 1px, transparent 1px),
        radial-gradient(circle at 50% 85%, #666 0px 1px, transparent 1px),
        /* 45 RPM dots */
        radial-gradient(circle at 15% 50%, #888 0px 1px, transparent 1px),
        radial-gradient(circle at 85% 50%, #888 0px 1px, transparent 1px);
      opacity: 0.6;
    }
    
    .vinyl {
      position: absolute;
      inset: 10%;
      border-radius: 50%;
      background: 
        /* Grooves */
        repeating-radial-gradient(
          circle at 50% 50%,
          #0a0a0c 0px 1px,
          #151518 1px 2px
        ),
        /* Label */
        radial-gradient(circle at 50% 50%, #c9a227 0% 25%, transparent 25%),
        #111;
      box-shadow: 
        0 0 0 1px #222,
        0 0 20px rgba(0,0,0,0.8);
      cursor: grab;
      transform-origin: center;
      will-change: transform;
    }
    
    .vinyl:active { cursor: grabbing; }
    
    .vinyl-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30%;
      aspect-ratio: 1;
      background: linear-gradient(135deg, #d4af37 0%, #c9a227 50%, #b8941f 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: bold;
      color: #333;
      text-align: center;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
    }
    
    .spindle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: silver;
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
      z-index: 10;
    }
    
    /* Realistic tonearm */
    .tonearm-assembly {
      position: absolute;
      right: -30px;
      top: 20%;
      width: 180px;
      height: 180px;
      pointer-events: none;
    }
    
    .pivot {
      position: absolute;
      right: 0;
      top: 0;
      width: 40px;
      height: 40px;
      background: linear-gradient(145deg, #444, #222);
      border-radius: 50%;
      border: 2px solid #555;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    .tonearm {
      position: absolute;
      right: 20px;
      top: 20px;
      width: 140px;
      height: 6px;
      background: linear-gradient(90deg, #666, #999, #666);
      transform-origin: right center;
      transform: rotate(-30deg);
      border-radius: 3px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      transition: transform 0.1s;
    }
    
    .tonearm.playing {
      transform: rotate(15deg);
      transition: transform 2s ease-out;
    }
    
    .headshell {
      position: absolute;
      left: -15px;
      top: -4px;
      width: 20px;
      height: 14px;
      background: #222;
      border: 1px solid #444;
      border-radius: 2px;
    }
    
    .counterweight {
      position: absolute;
      right: -10px;
      top: -8px;
      width: 24px;
      height: 24px;
      background: linear-gradient(145deg, #555, #333);
      border-radius: 50%;
      border: 1px solid #666;
    }
    
    /* Strobe light */
    .strobe-light {
      position: absolute;
      left: 20px;
      bottom: 20px;
      width: 30px;
      height: 10px;
      background: #222;
      border: 1px solid #444;
      border-radius: 2px;
      overflow: hidden;
    }
    
    .strobe-light::after {
      content: '';
      position: absolute;
      inset: 1px;
      background: var(--led);
      opacity: 0;
      box-shadow: 0 0 10px var(--led);
      animation: strobe 0.1s infinite;
    }
    
    .strobe-light.active::after {
      opacity: 1;
    }
    
    @keyframes strobe {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    /* Pitch slider - crucial for DJing */
    .pitch-section {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .pitch-slider-container {
      height: 200px;
      width: 40px;
      background: linear-gradient(90deg, #1a1a1f, #0f0f12, #1a1a1f);
      border: 2px solid #333;
      border-radius: 20px;
      position: relative;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }
    
    .pitch-slider {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 60px;
      background: linear-gradient(180deg, #444, #222);
      border: 1px solid #555;
      border-radius: 4px;
      cursor: ns-resize;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      top: 50%;
      margin-top: -30px;
    }
    
    .pitch-slider::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 2px;
      background: var(--accent);
    }
    
    .pitch-label {
      font-size: 10px;
      color: var(--muted);
      text-align: center;
    }
    
    .pitch-value {
      font-size: 12px;
      color: var(--accent);
      font-family: monospace;
    }
    
    /* Controls section */
    .controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    
    .control-group {
      background: rgba(0,0,0,0.3);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #333;
    }
    
    .control-label {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
      letter-spacing: 1px;
    }
    
    .btn {
      background: linear-gradient(180deg, #333, #222);
      border: 1px solid #444;
      color: var(--text);
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.1s;
      width: 100%;
      margin-bottom: 5px;
      text-transform: uppercase;
    }
    
    .btn:hover {
      background: linear-gradient(180deg, #444, #333);
      border-color: #555;
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn.primary {
      background: linear-gradient(180deg, #c9a227, #a08020);
      border-color: #8b7020;
      color: #111;
    }
    
    .btn.primary:hover {
      background: linear-gradient(180deg, #d4af37, #b8941f);
    }
    
    .btn.cue {
      background: linear-gradient(180deg, #ff6b35, #cc5522);
      border-color: #aa4420;
      color: white;
    }
    
    .transport {
      display: flex;
      gap: 8px;
    }
    
    .transport .btn {
      flex: 1;
      padding: 15px 10px;
      font-size: 14px;
    }
    
    /* Start/Stop button like Technics */
    .start-stop {
      position: absolute;
      left: 20px;
      bottom: 60px;
      width: 50px;
      height: 50px;
      background: linear-gradient(145deg, #333, #222);
      border: 2px solid #444;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: var(--text);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: all 0.1s;
    }
    
    .start-stop:active {
      transform: scale(0.95);
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .start-stop.active {
      background: linear-gradient(145deg, #2a4a2a, #1a3a1a);
      border-color: #3a6a3a;
      color: #4a4;
    }
    
    /* File input styling */
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    
    .file-input-label {
      display: block;
      padding: 10px;
      background: linear-gradient(180deg, #2a2a35, #1a1a25);
      border: 2px dashed #444;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      color: var(--muted);
      transition: all 0.2s;
    }
    
    .file-input-label:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    /* LED indicators */
    .led {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #333;
      display: inline-block;
      margin-right: 5px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
    }
    
    .led.on {
      background: var(--led);
      box-shadow: 0 0 10px var(--led), inset 0 1px 2px rgba(255,255,255,0.3);
    }
    
    /* Time display */
    .time-display {
      font-family: 'Courier New', monospace;
      font-size: 18px;
      color: var(--accent);
      background: #0a0a0c;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #333;
      text-align: center;
      letter-spacing: 2px;
    }
    
    /* Scratch indicator */
    .scratch-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 10px;
      color: var(--led);
      opacity: 0;
      transition: opacity 0.1s;
      text-transform: uppercase;
      font-weight: bold;
    }
    
    .scratch-indicator.active {
      opacity: 1;
    }
    
    /* Info panel */
    .info {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
      max-width: 1200px;
      width: 100%;
    }
    
    .info strong { color: var(--accent); }
  </style>
</head>
<body>

  <div class="decks-container">
    <!-- Deck A -->
    <div class="deck" id="deckA">
      <div class="deck-header">
        <div class="deck-title">● Deck A</div>
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-size:10px;color:var(--muted)">POWER</span>
          <div class="power-btn" id="powerA"></div>
        </div>
      </div>
      
      <div class="platter-area">
        <div class="platter-base">
          <div class="strobe-ring">
            <div class="strobe-dots" id="strobeDotsA"></div>
          </div>
        </div>
        <div class="vinyl" id="vinylA">
          <div class="vinyl-label">SIDE A</div>
          <div class="spindle"></div>
        </div>
        
        <div class="tonearm-assembly">
          <div class="pivot"></div>
          <div class="tonearm" id="tonearmA">
            <div class="counterweight"></div>
            <div class="headshell"></div>
          </div>
        </div>
        
        <div class="strobe-light" id="strobeA"></div>
        <div class="start-stop" id="startStopA">START</div>
        
        <div class="pitch-section">
          <div class="pitch-label">PITCH</div>
          <div class="pitch-slider-container" id="pitchContainerA">
            <div class="pitch-slider" id="pitchSliderA"></div>
          </div>
          <div class="pitch-value" id="pitchValueA">0.0%</div>
        </div>
        
        <div class="scratch-indicator" id="scratchA">Scratching</div>
      </div>
      
      <div class="time-display" id="timeA">00:00 / 00:00</div>
      
      <div class="controls">
        <div class="control-group">
          <div class="control-label">Track</div>
          <div class="file-input-wrapper">
            <input type="file" id="fileA" accept="audio/*">
            <label class="file-input-label" for="fileA">Load Track</label>
          </div>
        </div>
        
        <div class="control-group">
          <div class="control-label">Transport</div>
          <div class="transport">
            <button class="btn cue" id="cueA">CUE</button>
            <button class="btn primary" id="playA">PLAY</button>
          </div>
        </div>
        
        <div class="control-group">
          <div class="control-label">Cue Point</div>
          <button class="btn" id="setCueA" style="margin-bottom:5px">Set Cue</button>
          <div style="font-size:10px;color:var(--muted)" id="cuePointA">Not set</div>
        </div>
      </div>
    </div>
    
    <!-- Deck B -->
    <div class="deck" id="deckB">
      <div class="deck-header">
        <div class="deck-title">● Deck B</div>
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-size:10px;color:var(--muted)">POWER</span>
          <div class="power-btn" id="powerB"></div>
        </div>
      </div>
      
      <div class="platter-area">
        <div class="platter-base">
          <div class="strobe-ring">
            <div class="strobe-dots" id="strobeDotsB"></div>
          </div>
        </div>
        <div class="vinyl" id="vinylB">
          <div class="vinyl-label">SIDE B</div>
          <div class="spindle"></div>
        </div>
        
        <div class="tonearm-assembly">
          <div class="pivot"></div>
          <div class="tonearm" id="tonearmB">
            <div class="counterweight"></div>
            <div class="headshell"></div>
          </div>
        </div>
        
        <div class="strobe-light" id="strobeB"></div>
        <div class="start-stop" id="startStopB">START</div>
        
        <div class="pitch-section">
          <div class="pitch-label">PITCH</div>
          <div class="pitch-slider-container" id="pitchContainerB">
            <div class="pitch-slider" id="pitchSliderB"></div>
          </div>
          <div class="pitch-value" id="pitchValueB">0.0%</div>
        </div>
        
        <div class="scratch-indicator" id="scratchB">Scratching</div>
      </div>
      
      <div class="time-display" id="timeB">00:00 / 00:00</div>
      
      <div class="controls">
        <div class="control-group">
          <div class="control-label">Track</div>
          <div class="file-input-wrapper">
            <input type="file" id="fileB" accept="audio/*">
            <label class="file-input-label" for="fileB">Load Track</label>
          </div>
        </div>
        
        <div class="control-group">
          <div class="control-label">Transport</div>
          <div class="transport">
            <button class="btn cue" id="cueB">CUE</button>
            <button class="btn primary" id="playB">PLAY</button>
          </div>
        </div>
        
        <div class="control-group">
          <div class="control-label">Cue Point</div>
          <button class="btn" id="setCueB" style="margin-bottom:5px">Set Cue</button>
          <div style="font-size:10px;color:var(--muted)" id="cuePointB">Not set</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="info">
    <strong>How to use:</strong> Power on the deck → Load audio file → Press START to spin platter → Press PLAY to drop needle → Drag vinyl to scratch (lift needle automatically) → Use PITCH slider to beatmatch (±8%) → CUE button returns to cue point and pauses. Realistic physics: motor torque, platter inertia, and pitch bend on nudge.
  </div>

  <script>
    class DJDeck {
      constructor(deckId) {
        this.id = deckId;
        this.letter = deckId.replace('deck', '');
        this.powered = false;
        this.playing = false;
        this.motorOn = false;
        this.cuePoint = null;
        this.currentTime = 0;
        this.duration = 0;
        this.rotation = 0;
        this.platterSpeed = 0; // Current angular velocity
        this.targetSpeed = 0;  // Target speed based on RPM
        this.rpm = 33.33;
        this.pitch = 0; // Percentage
        this.scratching = false;
        this.scratchVelocity = 0;
        this.lastScratchTime = 0;
        this.lastScratchAngle = 0;
        
        // Audio context
        this.audioContext = null;
        this.audioBuffer = null;
        this.sourceNode = null;
        this.gainNode = null;
        this.panner = null;
        
        // DOM elements
        this.elements = {
          power: document.getElementById(`power${this.letter}`),
          startStop: document.getElementById(`startStop${this.letter}`),
          vinyl: document.getElementById(`vinyl${this.letter}`),
          tonearm: document.getElementById(`tonearm${this.letter}`),
          strobe: document.getElementById(`strobe${this.letter}`),
          strobeDots: document.getElementById(`strobeDots${this.letter}`),
          pitchSlider: document.getElementById(`pitchSlider${this.letter}`),
          pitchContainer: document.getElementById(`pitchContainer${this.letter}`),
          pitchValue: document.getElementById(`pitchValue${this.letter}`),
          file: document.getElementById(`file${this.letter}`),
          playBtn: document.getElementById(`play${this.letter}`),
          cueBtn: document.getElementById(`cue${this.letter}`),
          setCueBtn: document.getElementById(`setCue${this.letter}`),
          cuePointDisplay: document.getElementById(`cuePoint${this.letter}`),
          timeDisplay: document.getElementById(`time${this.letter}`),
          scratchIndicator: document.getElementById(`scratch${this.letter}`)
        };
        
        this.init();
      }
      
      init() {
        // Power button
        this.elements.power.addEventListener('click', () => this.togglePower());
        
        // Start/Stop (motor)
        this.elements.startStop.addEventListener('click', () => this.toggleMotor());
        
        // File loading
        this.elements.file.addEventListener('change', (e) => this.loadFile(e));
        
        // Transport controls
        this.elements.playBtn.addEventListener('click', () => this.togglePlay());
        this.elements.cueBtn.addEventListener('click', () => this.cue());
        this.elements.setCueBtn.addEventListener('click', () => this.setCue());
        
        // Pitch slider
        this.initPitchSlider();
        
        // Scratching
        this.initScratching();
        
        // Animation loop
        this.animate();
      }
      
      async initAudio() {
        if (this.audioContext) return;
        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      
      togglePower() {
        this.powered = !this.powered;
        this.elements.power.classList.toggle('active', this.powered);
        if (!this.powered) {
          this.stopMotor();
          this.stop();
        }
      }
      
      toggleMotor() {
        if (!this.powered) return;
        this.motorOn = !this.motorOn;
        this.elements.startStop.classList.toggle('active', this.motorOn);
        this.elements.strobe.classList.toggle('active', this.motorOn);
        this.targetSpeed = this.motorOn ? (this.rpm / 60) * 360 : 0; // degrees per second
      }
      
      stopMotor() {
        this.motorOn = false;
        this.elements.startStop.classList.remove('active');
        this.elements.strobe.classList.remove('active');
        this.targetSpeed = 0;
      }
      
      async loadFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        await this.initAudio();
        const arrayBuffer = await file.arrayBuffer();
        this.audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
        this.duration = this.audioBuffer.duration;
        this.currentTime = 0;
        this.updateTimeDisplay();
        
        // Update label with filename
        const label = this.elements.vinyl.querySelector('.vinyl-label');
        label.textContent = file.name.slice(0, 8).toUpperCase();
      }
      
      initPitchSlider() {
        let dragging = false;
        const slider = this.elements.pitchSlider;
        const container = this.elements.pitchContainer;
        
        const updatePitch = (clientY) => {
          const rect = container.getBoundingClientRect();
          const percent = (clientY - rect.top) / rect.height;
          const value = (0.5 - percent) * 16; // ±8%
          this.pitch = Math.max(-8, Math.min(8, value));
          slider.style.top = `${(0.5 - this.pitch / 16) * 100}%`;
          slider.style.transform = 'translate(-50%, -50%)';
          this.elements.pitchValue.textContent = `${this.pitch > 0 ? '+' : ''}${this.pitch.toFixed(1)}%`;
          
          // Update playback rate if playing
          if (this.sourceNode) {
            this.sourceNode.playbackRate.value = 1 + (this.pitch / 100);
          }
        };
        
        slider.addEventListener('mousedown', (e) => {
          dragging = true;
          e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
          if (dragging) updatePitch(e.clientY);
        });
        
        document.addEventListener('mouseup', () => {
          dragging = false;
        });
      }
      
      initScratching() {
        const vinyl = this.elements.vinyl;
        let startAngle = 0;
        let startRotation = 0;
        
        const getAngle = (e) => {
          const rect = vinyl.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          const clientX = e.touches ? e.touches[0].clientX : e.clientX;
          const clientY = e.touches ? e.touches[0].clientY : e.clientY;
          return Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
        };
        
        const startScratch = (e) => {
          if (!this.powered) return;
          e.preventDefault();
          this.scratching = true;
          this.elements.scratchIndicator.classList.add('active');
          startAngle = getAngle(e);
          startRotation = this.rotation;
          this.lastScratchTime = performance.now();
          this.lastScratchAngle = startAngle;
          
          // Lift tonearm slightly during scratch
          if (this.playing) {
            this.elements.tonearm.style.transform = 'rotate(15deg) translateY(-5px)';
          }
        };
        
        const moveScratch = (e) => {
          if (!this.scratching) return;
          e.preventDefault();
          const angle = getAngle(e);
          const delta = angle - startAngle;
          this.rotation = startRotation + delta;
          
          // Calculate velocity for inertia
          const now = performance.now();
          const dt = (now - this.lastScratchTime) / 1000;
          if (dt > 0) {
            let angleDiff = angle - this.lastScratchAngle;
            if (angleDiff > 180) angleDiff -= 360;
            if (angleDiff < -180) angleDiff += 360;
            this.scratchVelocity = angleDiff / dt; // degrees per second
          }
          this.lastScratchTime = now;
          this.lastScratchAngle = angle;
          
          // Update audio position based on rotation
          if (this.duration) {
            const secondsPerRotation = 1.8; // 33⅓ RPM
            const deltaSeconds = (delta / 360) * secondsPerRotation;
            this.currentTime = Math.max(0, Math.min(this.duration, this.currentTime + deltaSeconds * 0.1));
            if (this.sourceNode) {
              // In real implementation, we'd seek the buffer
            }
          }
          
          vinyl.style.transform = `rotate(${this.rotation}deg)`;
        };
        
        const endScratch = () => {
          if (!this.scratching) return;
          this.scratching = false;
          this.elements.scratchIndicator.classList.remove('active');
          
          // Restore tonearm
          if (this.playing) {
            this.elements.tonearm.style.transform = 'rotate(15deg)';
          }
          
          // Apply inertia
          if (Math.abs(this.scratchVelocity) > 100) {
            this.platterSpeed = this.scratchVelocity;
          }
        };
        
        vinyl.addEventListener('mousedown', startScratch);
        vinyl.addEventListener('touchstart', startScratch, {passive: false});
        document.addEventListener('mousemove', moveScratch);
        document.addEventListener('touchmove', moveScratch, {passive: false});
        document.addEventListener('mouseup', endScratch);
        document.addEventListener('touchend', endScratch);
      }
      
      togglePlay() {
        if (!this.powered || !this.audioBuffer) return;
        
        if (this.playing) {
          this.stop();
        } else {
          this.play();
        }
      }
      
      play() {
        if (!this.motorOn) {
          // Auto-start motor if not spinning
          this.toggleMotor();
        }
        
        this.playing = true;
        this.elements.playBtn.textContent = 'PAUSE';
        this.elements.tonearm.classList.add('playing');
        
        // Create audio source
        this.sourceNode = this.audioContext.createBufferSource();
        this.sourceNode.buffer = this.audioBuffer;
        this.sourceNode.playbackRate.value = 1 + (this.pitch / 100);
        
        this.gainNode = this.audioContext.createGain();
        this.gainNode.gain.value = 0.8;
        
        // Add vinyl crackle noise
        const noise = this.createVinylNoise();
        
        this.sourceNode.connect(this.gainNode);
        noise.connect(this.gainNode);
        this.gainNode.connect(this.audioContext.destination);
        
        this.sourceNode.start(0, this.currentTime);
        noise.start();
        this.noiseNode = noise;
        
        this.startTime = this.audioContext.currentTime - this.currentTime;
      }
      
      createVinylNoise() {
        // Create realistic vinyl crackle
        const bufferSize = this.audioContext.sampleRate * 2;
        const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
        const data = buffer.getChannelData(0);
        
        for (let i = 0; i < bufferSize; i++) {
          // White noise with occasional pops
          let noise = (Math.random() * 2 - 1) * 0.02;
          if (Math.random() < 0.001) {
            noise += (Math.random() * 2 - 1) * 0.1; // Pop
          }
          data[i] = noise;
        }
        
        const noiseSource = this.audioContext.createBufferSource();
        noiseSource.buffer = buffer;
        noiseSource.loop = true;
        
        const noiseFilter = this.audioContext.createBiquadFilter();
        noiseFilter.type = 'lowpass';
        noiseFilter.frequency.value = 8000;
        
        noiseSource.connect(noiseFilter);
        return noiseFilter;
      }
      
      stop() {
        this.playing = false;
        this.elements.playBtn.textContent = 'PLAY';
        this.elements.tonearm.classList.remove('playing');
        
        if (this.sourceNode) {
          this.sourceNode.stop();
          this.sourceNode = null;
        }
        if (this.noiseNode) {
          this.noiseNode.stop();
          this.noiseNode = null;
        }
        
        // Update current time
        if (this.audioContext && this.startTime) {
          this.currentTime = this.audioContext.currentTime - this.startTime;
        }
      }
      
      cue() {
        if (this.cuePoint !== null) {
          this.currentTime = this.cuePoint;
          if (this.playing) {
            this.stop();
            this.play();
          } else {
            this.updateTimeDisplay();
          }
        } else {
          // If no cue set, stop and return to beginning
          this.stop();
          this.currentTime = 0;
          this.updateTimeDisplay();
        }
      }
      
      setCue() {
        this.cuePoint = this.currentTime;
        this.elements.cuePointDisplay.textContent = this.formatTime(this.cuePoint);
      }
      
      animate() {
        const now = performance.now();
        const dt = (now - (this.lastFrame || now)) / 1000;
        this.lastFrame = now;
        
        if (this.powered && !this.scratching) {
          // Physics simulation for platter
          if (Math.abs(this.platterSpeed - this.targetSpeed) > 1) {
            // Torque acceleration
            const torque = this.motorOn ? 200 : 50; // Motor on vs friction
            const diff = this.targetSpeed - this.platterSpeed;
            const accel = Math.sign(diff) * Math.min(Math.abs(diff), torque * dt);
            this.platterSpeed += accel;
          } else {
            this.platterSpeed = this.targetSpeed;
          }
          
          // Apply inertia from scratching
          if (Math.abs(this.scratchVelocity) > 10) {
            this.platterSpeed = this.scratchVelocity;
            this.scratchVelocity *= 0.95; // Decay
          }
          
          // Update rotation
          if (Math.abs(this.platterSpeed) > 0.1) {
            this.rotation += this.platterSpeed * dt;
            this.elements.vinyl.style.transform = `rotate(${this.rotation}deg)`;
            
            // Animate strobe dots opposite direction for visual effect
            this.elements.strobeDots.style.transform = `rotate(${-this.rotation * 0.5}deg)`;
          }
          
          // Update audio position if playing
          if (this.playing && this.sourceNode) {
            this.currentTime = (this.audioContext.currentTime - this.startTime) * (1 + this.pitch / 100);
            if (this.currentTime >= this.duration) {
              this.stop();
              this.currentTime = 0;
            }
            this.updateTimeDisplay();
          }
        }
        
        requestAnimationFrame(() => this.animate());
      }
      
      updateTimeDisplay() {
        this.elements.timeDisplay.textContent = 
          `${this.formatTime(this.currentTime)} / ${this.formatTime(this.duration)}`;
      }
      
      formatTime(seconds) {
        if (!isFinite(seconds)) return '00:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
    }
    
    // Initialize decks
    const deckA = new DJDeck('deckA');
    const deckB = new DJDeck('deckB');
  </script>
</body>
</html>